<!DOCTYPE html>
<html lang="ja">
<head>
  <!--
  APP: Smart Price
  FILE: index.html
  VERSION: v19.9c-hf13-pwa2-imgflow1
  DATE(JST): 2026-01-03 21:55 JST
  TITLE: é»’ç”»é¢å¯¾ç­–ï¼‹ç”»åƒæ¤œç´¢â†’è²¼ä»˜ãƒ•ãƒ­ãƒ¼ï¼ˆä¸€è¦§â†’æˆ»ã£ãŸã‚‰URLè²¼ã‚‹ï¼‰ï¼‹URLæ­£è¦åŒ–
  CHANGES:
  - èµ·å‹•æ™‚ã®å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ã‚’å»ƒæ­¢ï¼ˆhistory.replaceStateã§ ?b ä»˜ä¸ï¼‰â†’ é»’ç”»é¢ã‚’æ¸›ã‚‰ã™
  - ğŸ”ã¯å…ˆã«ç”»åƒæ¤œç´¢ï¼ˆä¸€è¦§ï¼‰ã‚’é–‹ã â†’ æˆ»ã£ãŸã‚‰URLè²¼ä»˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆå¥³æ€§ç›®ç·šã§è¿·ã„ã«ãã„å°ç·šï¼‰
  - Googleç”»åƒã®é•·ã„URLã‹ã‚‰ imgurl ç­‰ã‚’æŠ½å‡ºã—ã¦ç”»åƒURLã«æ­£è¦åŒ–
  - sw.js/manifest.json ãŒç„¡ã„ç’°å¢ƒã§ã®ã‚¨ãƒ©ãƒ¼ã‚’æŠ‘åˆ¶ï¼ˆSWã¯å­˜åœ¨ç¢ºèªã§ããŸã¨ãã®ã¿ç™»éŒ²ï¼‰
  AUTHOR: Yui
  BUILD_PARAM(b): ?b=2026-01-03_2155_imgflow1
  DEBUG_PARAM: &debug=1
  POLICY: UIã¯å¤§ããå¤‰ãˆãšã€å†…éƒ¨ã®æµã‚Œã ã‘æ”¹å–„
  -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#D50000" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>Smart Price v19.9c</title>

  <!-- PWAï¼ˆã‚ã‚‹ç’°å¢ƒã ã‘ã§OKï¼‰ -->
  <link id="manifestLink" rel="manifest" href="manifest.json" />

  <!-- UIï¼ˆæ—¢å­˜ã¨åŒç³»ã®Bootstrapï¼‰ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    body { font-family: sans-serif; background-color: #121212; color: #e0e0e0; padding-bottom: 90px; }
    .container { max-width: 980px; }
    .card { background: #1c1c1c; border: 1px solid rgba(255,255,255,.08); }
    .btn-primary { background: #D50000; border-color: #D50000; }
    .btn-primary:hover { background: #b80000; border-color: #b80000; }
    .form-control, .form-select { background: #141414; color: #e0e0e0; border: 1px solid rgba(255,255,255,.12); }
    .form-control:focus, .form-select:focus { border-color: rgba(213,0,0,.65); box-shadow: 0 0 0 .2rem rgba(213,0,0,.18); }
    .muted { color: rgba(255,255,255,.65); }
    .bottom-bar {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 1000;
      background: rgba(18,18,18,.95); border-top: 1px solid rgba(255,255,255,.10);
      padding: 10px;
    }
    .thumb {
      width: 54px; height: 54px; border-radius: 10px; object-fit: cover;
      border: 1px solid rgba(255,255,255,.15); background: #0f0f0f;
    }
    .list-row { display: flex; gap: 10px; align-items: center; }
    .grow { flex: 1; min-width: 0; }
    .line1 { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .line2 { font-size: 12px; color: rgba(255,255,255,.68); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .badge-soft { background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.10); }
    .toast-wrap { position: fixed; left: 50%; transform: translateX(-50%); bottom: 96px; z-index: 2000; width: min(520px, calc(100% - 20px)); }
    .toast-msg { background: rgba(0,0,0,.78); border: 1px solid rgba(255,255,255,.18); border-radius: 14px; padding: 12px 14px; }
    .debug-badge {
      position: fixed; top: 10px; right: 10px; z-index: 3000;
      font-size: 12px; background: rgba(213,0,0,.85); color: #fff;
      padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.25);
    }

    /* ã‹ã‚“ãŸã‚“ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆUIã¯å¢—ã‚„ã•ãšã€å†…éƒ¨ã®å°çª“ã ã‘ï¼‰ */
    .prompt-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.65); z-index: 4000;
      display: none; align-items: center; justify-content: center; padding: 14px;
    }
    .prompt-box {
      width: min(560px, 100%);
      background: #1c1c1c; border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px; padding: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
    }
    .prompt-title { font-weight: 700; margin-bottom: 6px; }
    .prompt-text { font-size: 13px; color: rgba(255,255,255,.75); white-space: pre-wrap; }
    .prompt-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; }
  </style>
</head>

<body>
  <div id="debugBadge" class="debug-badge" style="display:none;"></div>

  <div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div>
        <div class="h5 mb-0">Smart Price</div>
        <div class="muted" style="font-size:12px;">
          <span id="buildInfo"></span>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button id="btnSettings" class="btn btn-sm btn-outline-light"><i class="bi bi-gear"></i></button>
        <button id="btnSync" class="btn btn-sm btn-primary"><i class="bi bi-arrow-repeat"></i> åŒæœŸ</button>
      </div>
    </div>

    <!-- å…¥åŠ› -->
    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-12 col-md-4">
          <label class="form-label mb-1">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</label>
          <input id="barcode" class="form-control" placeholder="ä¾‹: 4901234567890">
        </div>
        <div class="col-12 col-md-8">
          <label class="form-label mb-1">å•†å“å</label>
          <input id="name" class="form-control" placeholder="ä¾‹: ãŠèŒ¶ 2L">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label mb-1">ãƒ¡ãƒ¼ã‚«ãƒ¼</label>
          <input id="maker" class="form-control" placeholder="ä¾‹: â—‹â—‹é£Ÿå“">
        </div>

        <div class="col-6 col-md-4">
          <label class="form-label mb-1">åº—å</label>
          <input id="store" class="form-control" placeholder="ä¾‹: ã‚«ã‚¹ãƒŸ">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label mb-1">ä¾¡æ ¼</label>
          <input id="price" class="form-control" inputmode="numeric" placeholder="ä¾‹: 198">
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label mb-1">æ—¥ä»˜</label>
          <input id="date" class="form-control" type="date">
        </div>

        <div class="col-12">
          <label class="form-label mb-1">ãƒ¡ãƒ¢</label>
          <input id="note" class="form-control" placeholder="ä¾‹: ç‰¹å£²ãƒ»ã‚µã‚¤ã‚ºé•ã„æ³¨æ„">
        </div>

        <!-- ç”»åƒ -->
        <div class="col-12">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
              <img id="imgPreview" class="thumb" alt="">
              <div class="muted" style="font-size:12px;">
                <div class="line1" id="imgLabel">ç”»åƒï¼šæœªè¨­å®š</div>
                <div class="line2" id="imgHint">ğŸ”ã¯ã€Œæ¤œç´¢ä¸€è¦§ â†’ æˆ»ã£ãŸã‚‰URLè²¼ä»˜ã€</div>
              </div>
            </div>
            <div class="d-flex gap-2">
              <label class="btn btn-sm btn-outline-light mb-0">
                <i class="bi bi-image"></i> ç”»åƒã‚’é¸ã¶
                <input id="fileImage" type="file" accept="image/*" style="display:none;">
              </label>
              <button id="btnImageWeb" class="btn btn-sm btn-outline-light" title="ãƒãƒƒãƒˆç”»åƒï¼ˆURLï¼‰"><i class="bi bi-search"></i></button>
              <button id="btnClearImage" class="btn btn-sm btn-outline-light" title="ç”»åƒã‚¯ãƒªã‚¢"><i class="bi bi-x-circle"></i></button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- æœ€æ–°è³¼å…¥ -->
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="h6 mb-0">æœ€æ–°ã®è³¼å…¥</div>
      <div class="muted" style="font-size:12px;"><span id="countInfo"></span></div>
    </div>

    <div id="list" class="d-grid gap-2 mb-3"></div>

    <!-- å±¥æ­´ -->
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="h6 mb-0">è³¼å…¥å±¥æ­´</div>
      <button id="btnExport" class="btn btn-sm btn-outline-light"><i class="bi bi-box-arrow-up-right"></i> æ›¸ãå‡ºã—</button>
    </div>
    <div id="history" class="d-grid gap-2"></div>
  </div>

  <!-- ä¸‹ãƒãƒ¼ -->
  <div class="bottom-bar">
    <div class="container d-flex gap-2">
      <button id="btnSave" class="btn btn-primary w-50"><i class="bi bi-check2-circle"></i> ä¿å­˜</button>
      <button id="btnNew" class="btn btn-outline-light w-25"><i class="bi bi-plus-circle"></i> æ–°è¦</button>
      <button id="btnDelete" class="btn btn-outline-light w-25"><i class="bi bi-trash3"></i> å‰Šé™¤</button>
    </div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div class="toast-wrap" id="toastWrap" style="display:none;">
    <div class="toast-msg" id="toastMsg"></div>
  </div>

  <!-- ã‹ã‚“ãŸã‚“ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ -->
  <div class="prompt-backdrop" id="promptBackdrop">
    <div class="prompt-box">
      <div class="prompt-title" id="promptTitle">å…¥åŠ›</div>
      <div class="prompt-text mb-2" id="promptText"></div>
      <input class="form-control" id="promptInput" placeholder="">
      <div class="prompt-actions">
        <button class="btn btn-outline-light btn-sm" id="promptCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary btn-sm" id="promptOk">OK</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   Build / Params
========================= */
const APP_VERSION = "v19.9c-hf13-pwa2-imgflow1";
const BUILD_ID     = "2026-01-03_2155_imgflow1";
const DEFAULT_BUILD = BUILD_ID;

function getParam(name) {
  try { return new URL(location.href).searchParams.get(name); } catch(e) { return null; }
}
function isDebug() { return getParam('debug') === '1'; }

function ensureBuildParamNoReload() {
  // é»’ç”»é¢ã«ãªã‚Šã‚„ã™ã„ã€Œå¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ã€ã‚’ã‚„ã‚ã‚‹ï¼ˆç”»é¢é·ç§»ãªã—ã§ ?b ã‚’ä»˜ä¸ï¼‰
  try {
    const u = new URL(location.href);
    if (!u.searchParams.get('b')) {
      u.searchParams.set('b', DEFAULT_BUILD);
      history.replaceState(null, "", u.toString());
    }
  } catch(e) {}
}

function setBuildUi() {
  const b = getParam('b') || DEFAULT_BUILD;
  document.getElementById('buildInfo').textContent = `${APP_VERSION} / BUILD ${b}`;
  if (isDebug()) {
    const el = document.getElementById('debugBadge');
    el.style.display = 'block';
    el.textContent = `DEBUG / ${APP_VERSION} / ${b}`;
  }
  // manifestã«bã‚’ä»˜ä¸ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ï¼‰
  const ml = document.getElementById('manifestLink');
  if (ml) ml.href = `manifest.json?b=${encodeURIComponent(b)}`;
}

/* =========================
   Toast
========================= */
let toastTimer = null;
function showToast(msg, ms=4500) {
  const wrap = document.getElementById('toastWrap');
  const box = document.getElementById('toastMsg');
  box.textContent = msg;
  wrap.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ wrap.style.display = 'none'; }, ms);
}

/* =========================
   Simple Prompt
========================= */
let promptResolve = null;
function customPrompt(title, text, initialValue="") {
  const bd = document.getElementById('promptBackdrop');
  const t  = document.getElementById('promptTitle');
  const tx = document.getElementById('promptText');
  const ip = document.getElementById('promptInput');
  t.textContent = title || "å…¥åŠ›";
  tx.textContent = text || "";
  ip.value = initialValue || "";
  bd.style.display = "flex";
  ip.focus();
  ip.select();

  return new Promise((resolve) => {
    promptResolve = resolve;
  });
}
function closePrompt(val) {
  const bd = document.getElementById('promptBackdrop');
  bd.style.display = "none";
  const r = promptResolve;
  promptResolve = null;
  if (r) r(val);
}
document.getElementById('promptOk').addEventListener('click', ()=> closePrompt(document.getElementById('promptInput').value));
document.getElementById('promptCancel').addEventListener('click', ()=> closePrompt(null));
document.getElementById('promptInput').addEventListener('keydown', (e)=>{
  if (e.key === 'Enter') closePrompt(document.getElementById('promptInput').value);
  if (e.key === 'Escape') closePrompt(null);
});

/* =========================
   IndexedDB for images
========================= */
const IMG_DB_NAME = "SmartPriceImages";
const IMG_STORE   = "images";
let imgDbPromise = null;
const memImgCache = new Map();

function openImgDb() {
  if (imgDbPromise) return imgDbPromise;
  imgDbPromise = new Promise((resolve, reject) => {
    const req = indexedDB.open(IMG_DB_NAME, 1);
    req.onupgradeneeded = (ev) => {
      const db = ev.target.result;
      if (!db.objectStoreNames.contains(IMG_STORE)) {
        db.createObjectStore(IMG_STORE, { keyPath: "key" });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
  return imgDbPromise;
}
function idbPutImage(dataUrl) {
  return new Promise(async (resolve, reject) => {
    const db = await openImgDb();
    const tx = db.transaction(IMG_STORE, "readwrite");
    const st = tx.objectStore(IMG_STORE);
    const key = `img_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    st.put({ key, dataUrl, ts: Date.now() });
    tx.oncomplete = ()=> resolve(key);
    tx.onerror = ()=> reject(tx.error);
  });
}
function idbGetImage(key) {
  if (!key) return Promise.resolve(null);
  if (memImgCache.has(key)) return Promise.resolve(memImgCache.get(key));
  return new Promise(async (resolve, reject) => {
    const db = await openImgDb();
    const tx = db.transaction(IMG_STORE, "readonly");
    const st = tx.objectStore(IMG_STORE);
    const rq = st.get(key);
    rq.onsuccess = ()=> {
      const rec = rq.result;
      const v = rec ? rec.dataUrl : null;
      if (v) memImgCache.set(key, v);
      resolve(v);
    };
    rq.onerror = ()=> reject(rq.error);
  });
}
function idbDelImage(key) {
  if (!key) return Promise.resolve();
  memImgCache.delete(key);
  return new Promise(async (resolve, reject) => {
    const db = await openImgDb();
    const tx = db.transaction(IMG_STORE, "readwrite");
    tx.objectStore(IMG_STORE).delete(key);
    tx.oncomplete = ()=> resolve();
    tx.onerror = ()=> reject(tx.error);
  });
}

/* =========================
   Image helpers
========================= */
async function fileToResizedDataUrl(file, maxSide=900, quality=0.82) {
  const img = new Image();
  const dataUrl = await new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = ()=> reject(fr.error);
    fr.readAsDataURL(file);
  });
  img.src = dataUrl;
  await new Promise((res)=> img.onload = res);

  const w = img.naturalWidth || img.width;
  const h = img.naturalHeight || img.height;
  let nw = w, nh = h;
  const scale = Math.min(1, maxSide / Math.max(w, h));
  nw = Math.round(w * scale); nh = Math.round(h * scale);

  const cv = document.createElement('canvas');
  cv.width = nw; cv.height = nh;
  const ctx = cv.getContext('2d');
  ctx.drawImage(img, 0, 0, nw, nh);

  // JPEGã§è»½ãï¼ˆé»’èƒŒæ™¯ã‚¢ãƒ—ãƒªã®ç›¸æ€§ã‚‚è‰¯ã„ï¼‰
  return cv.toDataURL('image/jpeg', quality);
}

function looksLikeDirectImageUrl(url) {
  try {
    const u = new URL(url);
    const p = (u.pathname || "").toLowerCase();
    return /\.(png|jpg|jpeg|webp|gif|bmp|avif)$/.test(p);
  } catch(e) { return false; }
}

function extractImgUrlFromGoogle(url) {
  // ä¾‹: https://www.google.com/imgres?imgurl=...&imgrefurl=...
  try {
    const u = new URL(url);
    const p = u.searchParams;
    const imgurl = p.get('imgurl') || p.get('mediaurl') || p.get('imgrefurl');
    if (imgurl) return decodeURIComponent(imgurl);
  } catch(e) {}
  return null;
}

function normalizeImageUrl(input) {
  if (!input) return null;
  let s = String(input).trim();

  // å…ˆé ­/æœ«å°¾ã®å¼•ç”¨ç¬¦ã‚’é™¤å»
  s = s.replace(/^["'`]+/, '').replace(/["'`]+$/, '');

  // Googleç”»åƒã®é•·ã„URLã‹ã‚‰æŠ½å‡º
  const extracted = extractImgUrlFromGoogle(s);
  if (extracted) s = extracted.trim();

  // ãŸã¾ã«æœ«å°¾ã«ä½™è¨ˆãªæ–‡å­—ãŒä»˜ãã®ã‚’è»½ãé™¤å»
  s = s.replace(/\s/g, '');

  // URLã¨ã—ã¦æˆç«‹ã™ã‚‹ã‹ç¢ºèª
  try { new URL(s); } catch(e) { return null; }
  return s;
}

async function tryResolveOgImage(pageUrl) {
  // ç”»åƒURLã§ãªã‘ã‚Œã°ã€ãƒšãƒ¼ã‚¸URLã‹ã‚‰ og:image / twitter:image ã‚’æ‹¾ãˆãŸã‚‰æ‹¾ã†
  // ç›´æ¥fetchã¯CORSã§è½ã¡ã‚„ã™ã„ â†’ r.jina.ai ã‚’çµŒç”±ï¼ˆå–ã‚Œãªã„æ™‚ã¯è«¦ã‚ã¦pageUrlã®ã¾ã¾ï¼‰
  try {
    const u = new URL(pageUrl);
    const proxy = "https://r.jina.ai/" + u.href; // ä¾‹: https://r.jina.ai/https://example.com/...
    const res = await fetch(proxy, { cache: "no-store" });
    if (!res.ok) return pageUrl;
    const txt = await res.text();

    const pick = (re) => {
      const m = txt.match(re);
      if (!m) return null;
      return (m[1] || "").trim();
    };

    let img = null;
    img = img || pick(/property=["']og:image["'][^>]*content=["']([^"']+)["']/i);
    img = img || pick(/name=["']twitter:image["'][^>]*content=["']([^"']+)["']/i);
    img = img || pick(/name=["']twitter:image:src["'][^>]*content=["']([^"']+)["']/i);

    if (!img) return pageUrl;

    // ç›¸å¯¾URLã‚’çµ¶å¯¾ã«
    try { img = new URL(img, u.origin).href; } catch(e) {}
    return img;
  } catch(e) {
    return pageUrl;
  }
}

/* =========================
   Data model
========================= */
const LS_KEY = "SMART_PRICE_DB_V3";

let db = null;
let currentBarcode = "";
let tempImg = { type: "none" }; // {type:'db', key} or {type:'url', url} or none
let pendingImageSearch = null;  // {barcode,name,ts}

function nowDateStr() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function yen(n) {
  const x = Number(n || 0);
  if (!isFinite(x)) return "";
  return x.toLocaleString('ja-JP');
}

function defaultDb() {
  return {
    v: 3,
    updatedAt: Date.now(),
    settings: {
      firebaseUrl: "", // ä¾‹: https://xxxx-default-rtdb.firebaseio.com/smartprice.json
      deviceName: "",
      lastSyncAt: 0
    },
    products: {},   // barcode -> {barcode,name,maker,note,imageKey,imageUrl,last:{...}}
    purchases: []   // {id, ts, barcode, date, store, price, note, imageKey,imageUrl}
  };
}

function loadDb() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    db = raw ? JSON.parse(raw) : defaultDb();
  } catch(e) {
    db = defaultDb();
  }
  normalizeDb();
}

function makeSlimDbForStorage(obj) {
  // ç”»åƒãƒ‡ãƒ¼ã‚¿ã¯æŒãŸãªã„ï¼ˆkey/urlã ã‘ï¼‰
  const slim = JSON.parse(JSON.stringify(obj || defaultDb()));
  slim.updatedAt = Date.now();
  // purchasesã«å·¨å¤§ãƒ‡ãƒ¼ã‚¿ãŒæ··ã–ã‚‰ãªã„ã‚ˆã†ä¿é™º
  for (const p of slim.purchases) {
    delete p.imageData;
  }
  return slim;
}

function saveDb() {
  db.updatedAt = Date.now();
  const slim = makeSlimDbForStorage(db);
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(slim));
  } catch(e) {
    // å®¹é‡ãŒå³ã—ã„ã¨ãã¯å±¥æ­´ã‚’å¤ã„é †ã«å‰Šã£ã¦æ•‘ã†
    try {
      showToast("ä¿å­˜å®¹é‡ãŒå³ã—ã„ã®ã§ã€å¤ã„å±¥æ­´ã‹ã‚‰é–“å¼•ãã¾ã™â€¦", 6000);
      while (slim.purchases.length > 50) slim.purchases.shift();
      localStorage.setItem(LS_KEY, JSON.stringify(slim));
      db = slim;
    } catch(e2) {
      showToast("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå®¹é‡ï¼‰ã€‚ç”»åƒURLé‹ç”¨ãŒãŠã™ã™ã‚ã§ã™ã€‚", 8000);
    }
  }
}

function normalizeDb() {
  if (!db || typeof db !== "object") db = defaultDb();
  if (!db.v) db.v = 3;
  if (!db.settings) db.settings = defaultDb().settings;
  if (!db.products) db.products = {};
  if (!Array.isArray(db.purchases)) db.purchases = [];
}

/* =========================
   UI helpers
========================= */
const $ = (id)=> document.getElementById(id);

function clearForm() {
  $("barcode").value = "";
  $("name").value = "";
  $("maker").value = "";
  $("store").value = "";
  $("price").value = "";
  $("date").value = nowDateStr();
  $("note").value = "";
  tempImg = { type: "none" };
  currentBarcode = "";
  updateImgPreview();
}

function setFormFromProduct(barcode) {
  const pr = db.products[barcode];
  if (!pr) return;
  currentBarcode = barcode;
  $("barcode").value = pr.barcode || barcode;
  $("name").value = pr.name || "";
  $("maker").value = pr.maker || "";
  $("note").value = pr.note || "";
  // æœ€çµ‚è³¼å…¥ãŒã‚ã‚Œã°ãã‚Œã‚’å…¥ã‚Œã‚‹
  const last = pr.last || {};
  $("store").value = last.store || "";
  $("price").value = last.price != null ? String(last.price) : "";
  $("date").value = last.date || nowDateStr();

  // ç”»åƒã¯ã€Œç·¨é›†ç”¨ã€ã«ä¸€æ—¦ã‚»ãƒƒãƒˆ
  if (pr.imageKey) tempImg = { type: "db", key: pr.imageKey };
  else if (pr.imageUrl) tempImg = { type: "url", url: pr.imageUrl };
  else tempImg = { type: "none" };
  updateImgPreview();
}

async function updateImgPreview() {
  const img = $("imgPreview");
  const label = $("imgLabel");

  if (tempImg.type === "db" && tempImg.key) {
    const dataUrl = await idbGetImage(tempImg.key);
    if (dataUrl) {
      img.src = dataUrl;
      label.textContent = "ç”»åƒï¼šã“ã®ç«¯æœ«ã®ç”»åƒï¼ˆå…±æœ‰ã—ãªã„ï¼‰";
      return;
    }
    // keyãŒå£Šã‚Œã¦ã‚‹
    tempImg = { type: "none" };
  }
  if (tempImg.type === "url" && tempImg.url) {
    img.src = tempImg.url;
    label.textContent = "ç”»åƒï¼šURLï¼ˆåŒæœŸã§å…±æœ‰OKï¼‰";
    return;
  }
  img.removeAttribute("src");
  label.textContent = "ç”»åƒï¼šæœªè¨­å®š";
}

/* =========================
   Render lists
========================= */
async function render() {
  // æœ€æ–°è³¼å…¥ï¼ˆç›´è¿‘10ä»¶ï¼‰
  const listEl = $("list");
  const histEl = $("history");
  listEl.innerHTML = "";
  histEl.innerHTML = "";

  const purchases = [...db.purchases].sort((a,b)=> (b.ts||0)-(a.ts||0));
  $("countInfo").textContent = `å•†å“ ${Object.keys(db.products).length} / å±¥æ­´ ${db.purchases.length}`;

  const top = purchases.slice(0, 10);
  for (const p of top) {
    const pr = db.products[p.barcode] || {};
    const card = document.createElement('div');
    card.className = "card p-2";
    card.innerHTML = `
      <div class="list-row">
        <img class="thumb" data-img="1" alt="">
        <div class="grow">
          <div class="line1">${escapeHtml(pr.name || "(ç„¡é¡Œ)")}</div>
          <div class="line2">${escapeHtml(p.store || "")} / ${escapeHtml(p.date || "")} / Â¥${yen(p.price)}</div>
        </div>
        <span class="badge badge-soft">${escapeHtml(p.barcode || "")}</span>
      </div>
    `;
    card.addEventListener('click', ()=> setFormFromProduct(p.barcode));
    listEl.appendChild(card);

    // ç”»åƒ
    const img = card.querySelector('img[data-img="1"]');
    await fillThumb(img, pr, p);
  }

  // å±¥æ­´ï¼ˆç›´è¿‘50ä»¶ï¼‰
  const mid = purchases.slice(0, 50);
  for (const p of mid) {
    const pr = db.products[p.barcode] || {};
    const card = document.createElement('div');
    card.className = "card p-2";
    card.innerHTML = `
      <div class="list-row">
        <img class="thumb" data-img="2" alt="">
        <div class="grow">
          <div class="line1">${escapeHtml(pr.name || "(ç„¡é¡Œ)")}</div>
          <div class="line2">${escapeHtml(p.store || "")} / ${escapeHtml(p.date || "")} / Â¥${yen(p.price)} ${p.note ? " / "+escapeHtml(p.note) : ""}</div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-light" data-edit="1"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-light" data-del="1"><i class="bi bi-trash3"></i></button>
        </div>
      </div>
    `;
    card.querySelector('[data-edit="1"]').addEventListener('click', (e)=>{ e.stopPropagation(); editPurchase(p.id); });
    card.querySelector('[data-del="1"]').addEventListener('click', (e)=>{ e.stopPropagation(); deletePurchase(p.id); });
    histEl.appendChild(card);

    const img = card.querySelector('img[data-img="2"]');
    await fillThumb(img, pr, p);
  }
}

async function fillThumb(imgEl, pr, p) {
  // å„ªå…ˆï¼šè³¼å…¥ã®ç”»åƒ â†’ å•†å“ã®ç”»åƒ
  const k = p.imageKey || pr.imageKey;
  const u = p.imageUrl || pr.imageUrl;

  if (k) {
    const d = await idbGetImage(k);
    if (d) { imgEl.src = d; return; }
  }
  if (u) { imgEl.src = u; return; }

  imgEl.removeAttribute("src");
}

function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, (c)=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  })[c]);
}

/* =========================
   CRUD
========================= */
function upsertProductFromForm() {
  const barcode = $("barcode").value.trim();
  if (!barcode) { showToast("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™ã€‚", 4000); return null; }

  const name = $("name").value.trim();
  const maker = $("maker").value.trim();
  const store = $("store").value.trim();
  const price = Number(($("price").value || "").replace(/[^\d]/g,'')) || 0;
  const date  = $("date").value || nowDateStr();
  const note  = $("note").value.trim();

  const pr = db.products[barcode] || { barcode };
  pr.barcode = barcode;
  pr.name = name;
  pr.maker = maker;
  pr.note = note;

  // ç”»åƒ
  if (tempImg.type === "db") {
    pr.imageKey = tempImg.key || null;
    pr.imageUrl = null;
  } else if (tempImg.type === "url") {
    pr.imageUrl = tempImg.url || null;
    pr.imageKey = null;
  } else {
    // å¤‰æ›´ã—ãªã„ã€ã§ã¯ãªãã€Œæœªè¨­å®šã€ã§ä¸Šæ›¸ã
    pr.imageKey = null;
    pr.imageUrl = null;
  }

  pr.last = { store, price, date, note };
  db.products[barcode] = pr;

  // å±¥æ­´1ä»¶è¿½åŠ 
  const purchase = {
    id: `p_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    ts: Date.now(),
    barcode, store, price, date,
    note,
    imageKey: (tempImg.type === "db") ? (tempImg.key || null) : null,
    imageUrl: (tempImg.type === "url") ? (tempImg.url || null) : null
  };
  db.purchases.push(purchase);

  saveDb();
  showToast("ä¿å­˜ã—ã¾ã—ãŸã€‚", 2800);
  return barcode;
}

async function editPurchase(id) {
  const p = db.purchases.find(x=> x.id === id);
  if (!p) return;

  const pr = db.products[p.barcode] || {};
  const title = "å±¥æ­´ã‚’ç·¨é›†";
  const text = `å•†å“: ${pr.name || "(ç„¡é¡Œ)"}\n\nå½¢å¼ï¼šåº—åï½œä¾¡æ ¼ï½œæ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰\nä¾‹ï¼šã‚«ã‚¹ãƒŸï½œ198ï½œ2026-01-03`;
  const init = `${p.store || ""}ï½œ${p.price ?? ""}ï½œ${p.date || ""}`;
  const v = await customPrompt(title, text, init);
  if (!v) return;

  const parts = String(v).split("ï½œ").map(s=> s.trim());
  if (parts.length >= 1) p.store = parts[0] || p.store;
  if (parts.length >= 2) p.price = Number((parts[1]||"").replace(/[^\d]/g,'')) || p.price;
  if (parts.length >= 3) p.date = parts[2] || p.date;

  saveDb();
  await render();
  showToast("å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚", 3000);
}

async function deletePurchase(id) {
  const p = db.purchases.find(x=> x.id === id);
  if (!p) return;

  const v = await customPrompt("å‰Šé™¤ç¢ºèª", "ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰", "delete ã¨å…¥åŠ›");
  if (String(v || "").trim().toLowerCase() !== "delete") return;

  db.purchases = db.purchases.filter(x=> x.id !== id);
  saveDb();
  await render();
  showToast("å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚", 3000);
}

async function deleteCurrentProduct() {
  const barcode = $("barcode").value.trim();
  if (!barcode) { showToast("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™ã€‚", 4000); return; }
  const pr = db.products[barcode];
  if (!pr) { showToast("ãã®å•†å“ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", 4000); return; }

  const v = await customPrompt("å‰Šé™¤ç¢ºèª", "ã“ã®å•†å“ã¨é–¢é€£ã™ã‚‹å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆæˆ»ã›ã¾ã›ã‚“ï¼‰", "delete ã¨å…¥åŠ›");
  if (String(v || "").trim().toLowerCase() !== "delete") return;

  // ç”»åƒã‚­ãƒ¼ãŒã‚ã‚Œã°æ¶ˆã™ï¼ˆã“ã®ç«¯æœ«ã®ã¿ï¼‰
  if (pr.imageKey) await idbDelImage(pr.imageKey);

  delete db.products[barcode];
  db.purchases = db.purchases.filter(x=> x.barcode !== barcode);
  saveDb();
  clearForm();
  await render();
  showToast("å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚", 3500);
}

/* =========================
   Image actions
========================= */
$("fileImage").addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  try {
    const dataUrl = await fileToResizedDataUrl(f, 900, 0.82);
    const key = await idbPutImage(dataUrl);
    tempImg = { type:"db", key };
    await updateImgPreview();
    showToast("ç”»åƒã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã ã‘ï¼‰ã€‚å…±æœ‰ã—ãŸã„ãªã‚‰ğŸ”â†’URLãŒãŠã™ã™ã‚ã€‚", 7000);
  } catch(err) {
    showToast("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 6000);
  } finally {
    e.target.value = "";
  }
});

$("btnClearImage").addEventListener('click', async ()=>{
  tempImg = { type:"none" };
  await updateImgPreview();
  showToast("ç”»åƒã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚", 2500);
});

/* ---- å¥³æ€§ç›®ç·šï¼šğŸ”ã®æµã‚Œã‚’è¿·ã‚ãªã„å½¢ã« ----
   1) ã¾ãšæ¤œç´¢ï¼ˆä¸€è¦§ï¼‰ã‚’é–‹ã
   2) æˆ»ã£ã¦ããŸã‚‰ URLè²¼ä»˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
----------------------------------------- */
$("btnImageWeb").addEventListener('click', ()=> startImageSearchFlow());

function getDisplayMode() {
  // iOS standalone / PWA åˆ¤å®š
  const isStandalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
  const isIosStandalone = (navigator.standalone === true);
  return (isStandalone || isIosStandalone) ? "standalone" : "browser";
}
function openExternal(url) {
  // PWAã§ window.open ãŒå‹•ã‹ãªã„ç«¯æœ«ãŒã‚ã‚‹ã®ã§ã€ãƒ€ãƒ¡ãªã‚‰locationé·ç§»
  try {
    const w = window.open(url, "_blank", "noopener,noreferrer");
    if (w) return true;
  } catch(e) {}
  try { location.href = url; return true; } catch(e) {}
  return false;
}

function startImageSearchFlow() {
  const barcode = $("barcode").value.trim() || currentBarcode || "";
  const name = ($("name").value || "").trim() || "å•†å“ç”»åƒ";
  const q = encodeURIComponent(`${name} å•†å“ ç”»åƒ`);
  const url = `https://www.google.com/search?tbm=isch&q=${q}`;

  pendingImageSearch = { barcode, name, ts: Date.now() };
  try { localStorage.setItem("SP_PENDING_IMGSEARCH", JSON.stringify(pendingImageSearch)); } catch(e) {}

  openExternal(url);

  showToast("â‘ ç”»åƒã‚’é¸ã¶ â†’ â‘¡ã€Œç”»åƒã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã€â†’ â‘¢æˆ»ã‚‹ã¨è²¼ä»˜æ¬„ãŒå‡ºã¾ã™", 9000);
}

async function maybeOpenImageUrlPrompt() {
  if (promptResolve) return; // ã™ã§ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸­

  // pendingã‚’å¾©å…ƒ
  if (!pendingImageSearch) {
    try {
      const raw = localStorage.getItem("SP_PENDING_IMGSEARCH");
      if (raw) pendingImageSearch = JSON.parse(raw);
    } catch(e) {}
  }
  if (!pendingImageSearch) return;

  // 10åˆ†çµŒã£ãŸã‚‰ç ´æ£„
  if (Date.now() - (pendingImageSearch.ts||0) > 10*60*1000) {
    pendingImageSearch = null;
    try { localStorage.removeItem("SP_PENDING_IMGSEARCH"); } catch(e) {}
    return;
  }

  // ã“ã“ã§ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  let clip = "";
  // â€»è‡ªå‹•ã§èª­ã¿å–ã‚Œã‚‹ç«¯æœ«ã ã‘ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒå…¥ã‚‹ï¼ˆãƒ€ãƒ¡ãªã‚‰ç©ºã®ã¾ã¾ï¼‰
  try { clip = await navigator.clipboard.readText(); } catch(e) {}

  const title = "ç”»åƒURLã‚’è²¼ã‚‹";
  const text =
`è²¼ã‚Šæ–¹ï¼ˆãŠã™ã™ã‚ï¼‰
1) ç”»åƒã‚’é•·æŠ¼ã—ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ï¼‰
2) ã€Œç”»åƒã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã€
3) ã“ã“ã«è²¼ã‚Šä»˜ã‘ â†’ OK

â€»ãƒšãƒ¼ã‚¸URLã—ã‹ãªã„å ´åˆã§ã‚‚ã€ã§ãã‚‹ç¯„å›²ã§ç”»åƒã‚’è‡ªå‹•æŠ½å‡ºã—ã¾ã™ã€‚`;

  const v = await customPrompt(title, text, clip || "");
  if (!v) return;

  // pendingã¯ã“ã“ã§æ¶ˆã™ï¼ˆä½•åº¦ã‚‚å‡ºãªã„ã‚ˆã†ã«ï¼‰
  pendingImageSearch = null;
  try { localStorage.removeItem("SP_PENDING_IMGSEARCH"); } catch(e) {}

  const normalized = normalizeImageUrl(v);
  if (!normalized) {
    showToast("URLã¨ã—ã¦èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã€ç”»åƒã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è²¼ã£ã¦ãã ã•ã„ã€‚", 8000);
    return;
  }

  let finalUrl = normalized;

  // ç”»åƒã£ã½ããªã„URLãªã‚‰ã€og:imageç­‰ã‚’æ‹¾ãˆã‚‹ã‹è©¦ã™
  if (!looksLikeDirectImageUrl(finalUrl)) {
    showToast("ãƒšãƒ¼ã‚¸ã‹ã‚‰ç”»åƒã‚’æ¢ã—ã¦ã„ã¾ã™â€¦ï¼ˆå–ã‚Œãªã„æ™‚ã¯ãã®ã¾ã¾ä½¿ã„ã¾ã™ï¼‰", 6000);
    finalUrl = await tryResolveOgImage(finalUrl);
  }

  tempImg = { type:"url", url: finalUrl };
  await updateImgPreview();
  showToast("ç”»åƒãƒªãƒ³ã‚¯ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆåŒæœŸã§å…±æœ‰OKï¼‰ã€‚ä¿å­˜ãƒœã‚¿ãƒ³ã§ç¢ºå®šã—ã¾ã™ã€‚", 8000);
}

document.addEventListener('visibilitychange', ()=>{
  if (!document.hidden) {
    // æ¤œç´¢ã‚¿ãƒ–ã‹ã‚‰æˆ»ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§é–‹ã
    setTimeout(()=> { maybeOpenImageUrlPrompt(); }, 250);
  }
});

/* =========================
   Sync (Firebase RTDB JSON)
========================= */
async function firebasePull() {
  const url = (db.settings.firebaseUrl || "").trim();
  if (!url) { showToast("è¨­å®šã§Firebase URLã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚", 6000); return; }

  const res = await fetch(url, { cache:"no-store" });
  if (!res.ok) throw new Error("pull failed");
  const remote = await res.json();
  if (!remote || typeof remote !== "object") throw new Error("remote empty");

  // ã–ã£ãã‚Šãƒãƒ¼ã‚¸ï¼ˆåŸºæœ¬ã¯ãƒªãƒ¢ãƒ¼ãƒˆå„ªå…ˆï¼‰
  db = remote;
  normalizeDb();
  saveDb();
  showToast("åŒæœŸï¼šå–å¾—ã—ã¾ã—ãŸã€‚", 3500);
}

async function firebasePush() {
  const url = (db.settings.firebaseUrl || "").trim();
  if (!url) { showToast("è¨­å®šã§Firebase URLã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚", 6000); return; }

  const slim = makeSlimDbForStorage(db); // ç”»åƒãƒ‡ãƒ¼ã‚¿ã¯é€ã‚‰ãªã„
  const res = await fetch(url, {
    method: "PUT",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(slim)
  });
  if (!res.ok) throw new Error("push failed");
  db.settings.lastSyncAt = Date.now();
  saveDb();
  showToast("åŒæœŸï¼šé€ä¿¡ã—ã¾ã—ãŸã€‚", 3500);
}

async function doSync() {
  const mode = await customPrompt("åŒæœŸ", "ã©ã¡ã‚‰ã‚’ã—ã¾ã™ã‹ï¼Ÿ\n\npullï¼šFirebaseâ†’ã“ã®ç«¯æœ«\npushï¼šã“ã®ç«¯æœ«â†’Firebase", "pull");
  if (!mode) return;
  const m = String(mode).trim().toLowerCase();
  try {
    if (m === "pull") await firebasePull();
    else if (m === "push") await firebasePush();
    else showToast("pull / push ã®ã©ã¡ã‚‰ã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", 6000);
    await render();
  } catch(e) {
    showToast("åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã‚„Firebaseãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", 8000);
  }
}

/* =========================
   Settings / Export
========================= */
async function openSettings() {
  const cur = db.settings.firebaseUrl || "";
  const v = await customPrompt("è¨­å®š", "Firebase URLï¼ˆRealtime Databaseã® .json ã¾ã§ï¼‰ã‚’å…¥åŠ›\nä¾‹: https://xxxx-default-rtdb.firebaseio.com/smartprice.json", cur);
  if (v == null) return;
  db.settings.firebaseUrl = String(v).trim();
  saveDb();
  showToast("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚", 3000);
}

function exportJson() {
  const data = makeSlimDbForStorage(db);
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `smart-price_${BUILD_ID}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
  showToast("JSONã‚’æ›¸ãå‡ºã—ã¾ã—ãŸã€‚", 3500);
}

/* =========================
   PWA service worker safe register
========================= */
async function registerSwSafely() {
  if (!('serviceWorker' in navigator)) return;
  try {
    // sw.js ãŒç„¡ã„ç’°å¢ƒï¼ˆãƒ­ãƒ¼ã‚«ãƒ«/æœªé…ç½®ï¼‰ã§ã¯ç™»éŒ²ã—ãªã„
    const testUrl = `sw.js?b=${encodeURIComponent(getParam('b') || DEFAULT_BUILD)}`;
    const res = await fetch(testUrl, { cache:"no-store" });
    if (!res.ok) return;

    await navigator.serviceWorker.register(testUrl, { scope: "./" });
  } catch(e) {
    // å¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã¯å‹•ã
  }
}

/* =========================
   Wire events / Boot
========================= */
$("btnSave").addEventListener('click', async ()=>{
  const b = upsertProductFromForm();
  if (b) {
    currentBarcode = b;
    await render();
  }
});
$("btnNew").addEventListener('click', ()=> { clearForm(); showToast("æ–°è¦å…¥åŠ›ã«ã—ã¾ã—ãŸã€‚", 2500); });
$("btnDelete").addEventListener('click', ()=> deleteCurrentProduct());
$("btnSync").addEventListener('click', ()=> doSync());
$("btnSettings").addEventListener('click', ()=> openSettings());
$("btnExport").addEventListener('click', ()=> exportJson());

$("barcode").addEventListener('change', ()=>{
  const b = $("barcode").value.trim();
  if (db.products[b]) setFormFromProduct(b);
});

function initDateInput() {
  // PCã§dateãŒå‡ºãªã„å ´åˆãŒã‚ã‚‹ â†’ ãã®ã¾ã¾ã§ã‚‚å…¥åŠ›ã§ãã‚‹ã‚ˆã†ä¿é™ºï¼ˆtype=dateã®ã¾ã¾ï¼‰
  if (!$("date").value) $("date").value = nowDateStr();
}

(async function boot(){
  ensureBuildParamNoReload();
  setBuildUi();
  loadDb();
  initDateInput();
  clearForm();
  await render();
  await registerSwSafely();

  // èµ·å‹•ç›´å¾Œã®ã€Œé»’ã„ã ã‘ã€æ„Ÿã‚’æ¸›ã‚‰ã™ä¸€è¨€
  showToast("èµ·å‹•ã—ã¾ã—ãŸã€‚", 1200);

  // ã‚‚ã—ã€Œæ¤œç´¢ã‹ã‚‰æˆ»ã£ãŸã€ç›´å¾Œãªã‚‰URLè²¼ä»˜ã‚’å‡ºã™
  setTimeout(()=> maybeOpenImageUrlPrompt(), 400);
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
