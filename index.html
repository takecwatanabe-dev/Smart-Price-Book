<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Price v17.5</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { font-family: sans-serif; background-color: #000000; color: #ffffff; padding: 15px; }
        .header { border-bottom: 3px solid #D50000; margin-bottom: 20px; padding-bottom: 10px; }
        h1 { color: #D50000; font-weight: bold; font-size: 1.6rem; margin: 0; }
        .glass-panel { background: #1a1a1a; padding: 20px; border-radius: 4px; border: 1px solid #333; margin-bottom: 25px; }
        .form-label-custom { color: #bbb; font-size: 0.8rem; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; margin: 8px 0; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        input:focus { border-color: #D50000; outline: none; }
        .action-row { display: flex; align-items: center; gap: 10px; margin: 15px 0; }
        .btn-red { flex: 1; background: #D50000; color: white; border: none; padding: 12px; border-radius: 4px; font-weight: bold; }
        .btn-dark-custom { flex: 1; background: #333; color: white; border: 1px solid #444; padding: 12px; border-radius: 4px; }
        #preview-box { width: 60px; height: 60px; background: #000; border: 1px dashed #D50000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #preview-img { width: 100%; height: 100%; object-fit: contain; }
        .item-card { background: #1a1a1a; display: flex; border-radius: 4px; margin-bottom: 15px; border: 1px solid #333; overflow: hidden; }
        .card-img { width: 90px; height: 90px; border-right: 2px solid #D50000; object-fit: contain; background: #fff; }
        .card-body { flex: 1; padding: 10px 15px; }
        .mkr { color: #bbb; font-size: 0.8rem; }
        .name { font-size: 1.1rem; font-weight: bold; margin: 2px 0; color: #fff; }
        .prc { color: #D50000; font-size: 1.4rem; font-weight: bold; }
        #camera-area { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; }
        #interactive { width: 100%; height: 100%; }
        .settings-btn { position: absolute; top: 15px; right: 15px; color: #333; font-size: 1.5rem; }
    </style>
</head>
<body>
<div class="container">
    <div class="header d-flex justify-content-between align-items-center">
        <h1>Smart Price v17.5</h1>
        <i class="bi bi-gear-fill settings-btn" onclick="openSettings()"></i>
    </div>
    <div class="glass-panel">
        <div class="form-label-custom">INPUT DATA (Last Update: 2025-12-30 23:35)</div>
        <input type="text" id="itemName" placeholder="ÂïÜÂìÅÂêç„ÇíÂÖ•Âäõ">
        <input type="text" id="maker" placeholder="„É°„Éº„Ç´„Éº„ÉªÂ∫óËàó">
        <input type="number" id="price" placeholder="‰æ°Ê†º (ÂÜÜ)">
        <div class="action-row">
            <button class="btn-red" onclick="startScanner()"><i class="bi bi-upc-scan"></i> „Çπ„Ç≠„É£„É≥</button>
            <label class="btn-dark-custom" style="text-align:center;">üì∑ ÂÜôÁúü<input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImage(this)"></label>
            <div id="preview-box"><img id="preview-img" src=""></div>
        </div>
        <button class="btn-red w-100 py-3 mt-2" onclick="saveData()" style="font-size:1.2rem;">„É™„Çπ„Éà„Å´ËøΩÂä†„Åó„Å¶ÂêåÊúü</button>
    </div>
    <div id="listArea"></div>
</div>
<div id="camera-area"><div id="interactive"></div><button onclick="stopScanner()" class="btn btn-danger position-absolute top-0 end-0 m-4">√ó</button></div>
<div id="settingsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; align-items:center; justify-content:center;">
    <div style="background:#1a1a1a; padding:20px; border-radius:10px; width:90%; border:1px solid #D50000;">
        <h5 class="text-white">Firebase URL (wit-ai-apps)</h5>
        <input type="text" id="firebase-url" placeholder="https://xxx.firebaseio.com/">
        <button class="btn btn-danger w-100 mt-3" onclick="closeSettings()">Èñâ„Åò„Çã</button>
    </div>
</div>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    /* Internal Logic Refinement: 17.5.202512302335 */
    let db = { products: {} };
    let curBarcode = "MANUAL_" + Date.now();
    let tempImgData = "";
    let fbUrl = localStorage.getItem('smartPriceFirebaseUrl') || '';
    let scanner = null;

    window.onload = () => { loadLocal(); if(fbUrl) syncFirebase(); renderHistory(); };
    function loadLocal() { const saved = localStorage.getItem('smart_price_db'); if (saved) { try { db = JSON.parse(saved); } catch(e) { console.error("Data corruption"); } } }
    function getSafeFbUrl(url) { if(!url) return ""; let clean = url.trim().replace(/\/+$/, ""); return clean.endsWith(".json") ? clean : clean + "/db.json"; }

    async function syncFirebase() {
        const target = getSafeFbUrl(fbUrl);
        if (!target) return;
        try {
            const res = await fetch(target);
            if (!res.ok) return;
            const data = await res.json();
            if (data && data.db) { db = data.db; renderHistory(); }
        } catch(e) { console.warn("Firebase Offline: v17.5"); }
    }

    function handleImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 400;
                    let w = img.width, h = img.height;
                    if (w > h) { h *= MAX/w; w = MAX; } else { w *= MAX/h; h = MAX; }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    tempImgData = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('preview-img').src = tempImgData;
                    // Memory Cleanup
                    canvas.width = canvas.height = 0;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function saveData() {
        const name = document.getElementById('itemName').value;
        const price = document.getElementById('price').value;
        const maker = document.getElementById('maker').value || "---";
        if (!name || !price) { alert("ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
        if (!db.products[curBarcode]) db.products[curBarcode] = { history: [] };
        const p = db.products[curBarcode];
        p.name = name; p.maker = maker;
        p.image = tempImgData || p.image;
        p.history.push({ price: Number(price), ts: Date.now() });
        localStorage.setItem('smart_price_db', JSON.stringify(db));
        const target = getSafeFbUrl(fbUrl);
        if (target) {
            try {
                const res = await fetch(target, { method: 'PUT', body: JSON.stringify({ db: db }) });
                if(!res.ok) throw new Error();
            } catch(e) { console.error("Cloud save failed, local only."); }
        }
        renderHistory();
        document.getElementById('itemName').value = ""; document.getElementById('price').value = "";
        document.getElementById('preview-img').src = ""; tempImgData = "";
        curBarcode = "MANUAL_" + Date.now();
    }

    function renderHistory() {
        const list = document.getElementById('listArea');
        list.innerHTML = "";
        const items = Object.keys(db.products).map(k => ({ code: k, ...db.products[k] }));
        items.sort((a,b) => (b.history[b.history.length-1]?.ts || 0) - (a.history[a.history.length-1]?.ts || 0));
        items.forEach(it => {
            const last = it.history[it.history.length-1];
            if(!last) return;
            const div = document.createElement('div');
            div.className = 'item-card';
            div.innerHTML = `<img src="${it.image || ''}" class="card-img" onerror="this.src='https://placehold.jp/24/333/ccc/90x90.png?text=NoImage'"><div class="card-body"><div class="mkr">${it.maker}</div><div class="name">${it.name}</div><div class="prc">¬•${last.price.toLocaleString()}</div></div>`;
            list.appendChild(div);
        });
    }

    function startScanner() {
        document.getElementById('camera-area').style.display='block';
        if(!scanner) scanner = new Html5Qrcode("interactive");
        scanner.start({facingMode:"environment"},{fps:10,qrbox:250},(t)=>{
            curBarcode = t; stopScanner();
            if(db.products[t]) {
                document.getElementById('itemName').value = db.products[t].name;
                document.getElementById('maker').value = db.products[t].maker;
            }
        }).catch(()=>stopScanner());
    }
    function stopScanner() { if(scanner) { scanner.stop().catch(()=>{}); } document.getElementById('camera-area').style.display='none'; }
    function openSettings() { document.getElementById('settingsModal').style.display='flex'; }
    function closeSettings() { 
        fbUrl = document.getElementById('firebase-url').value;
        localStorage.setItem('smartPriceFirebaseUrl', fbUrl);
        document.getElementById('settingsModal').style.display='none'; 
        syncFirebase();
    }
</script>
</body>
</html>
